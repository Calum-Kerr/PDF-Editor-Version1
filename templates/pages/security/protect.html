{% extends 'base.html' %}
{% block title %}Protect PDF - RevisePDF{% endblock %}

{% block content %}
<div class="upload-section text-center">
    <h1 class="mb-3">Protect PDF</h1>
    <p class="mb-4">Add password protection to your PDF file.</p>

    <form action="{{ url_for('protect') }}" method="POST" enctype="multipart/form-data" class="mb-3" id="protectForm">
        <input type="file" name="file" id="fileInput" class="d-none" accept=".pdf" required>
        <label for="fileInput" class="btn btn-primary select-file-button">
            Select a file
        </label>
        <span id="selectedFileName" class="ms-2"></span>

        <div class="mt-3">
            <input type="password" name="user_password" placeholder="User Password" 
                   class="form-control mb-2" required>
            <input type="password" name="owner_password" placeholder="Owner Password" 
                   class="form-control mb-2" required>
            <input type="password" name="confirm_password" placeholder="Confirm User Password" 
                   class="form-control mb-2" required>
            <button type="submit" class="btn btn-primary">Protect PDF</button>
        </div>
    </form>

    {% if error %}
    <div class="alert alert-danger mt-3">{{ error }}</div>
    {% endif %}
    
    {% if success %}
    <div class="alert alert-success mt-3">{{ success }}</div>
    {% endif %}

    <p class="drag-drop-text mt-2">or drag and drop here</p>
    <div id="drop-zone" style="border: 2px dashed #ccc; padding: 20px; display: none;">
        Drop files here
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('protectForm');
    const fileInput = document.getElementById('fileInput');
    const fileNameSpan = document.getElementById('selectedFileName');

    // Show selected filename
    fileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            fileNameSpan.textContent = this.files[0].name;
        } else {
            fileNameSpan.textContent = '';
        }
    });

    // Form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Clear any existing messages
        const existingAlerts = document.querySelectorAll('.alert');
        existingAlerts.forEach(alert => alert.remove());
        
        if (!fileInput.files.length) {
            showMessage('Please select a PDF file', 'danger');
            return;
        }

        // Show loading message
        showMessage('Protecting PDF...', 'info');
        
        const formData = new FormData(form);
        
        try {
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData
            });

            const contentType = response.headers.get('content-type');
            
            if (contentType && contentType.includes('application/json')) {
                // Handle error response
                const data = await response.json();
                showMessage(data.error, 'danger');
            } else {
                // Handle PDF response
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `protected_${fileInput.files[0].name}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                // Show success message
                showMessage('PDF protected successfully! Downloading...', 'success');
                
                // Reset form
                form.reset();
                fileNameSpan.textContent = '';
            }
        } catch (error) {
            console.error('Error:', error);
            showMessage('An error occurred while protecting the PDF', 'danger');
        }
    });

    function showMessage(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} mt-3`;
        alertDiv.textContent = message;
        form.insertAdjacentElement('afterend', alertDiv);
    }
});
</script>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const userPasswordInput = document.getElementById('user_password');
        const ownerPasswordInput = document.getElementById('owner_password');
        const confirmPasswordInput = document.getElementById('confirm_password');

        // Check password match
        function checkPasswordMatch() {
            if (userPasswordInput.value && confirmPasswordInput.value) {
                if (userPasswordInput.value !== confirmPasswordInput.value) {
                    confirmPasswordInput.setCustomValidity('Passwords do not match');
                } else {
                    confirmPasswordInput.setCustomValidity('');
                }
            } else {
                confirmPasswordInput.setCustomValidity('');
            }
        }

        // Add event listeners
        if (userPasswordInput && confirmPasswordInput) {
            userPasswordInput.addEventListener('input', checkPasswordMatch);
            confirmPasswordInput.addEventListener('input', checkPasswordMatch);
        }

        // Form validation
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function(event) {
                // Check if at least one password is provided
                if (!userPasswordInput.value && !ownerPasswordInput.value) {
                    event.preventDefault();
                    alert('Please provide at least one password (user or owner).');
                    return;
                }

                // Check if passwords match
                if (userPasswordInput.value !== confirmPasswordInput.value) {
                    event.preventDefault();
                    alert('Passwords do not match.');
                    return;
                }
            });
        }
    });
</script>
{% endblock %}
